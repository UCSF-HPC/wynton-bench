#! /usr/bin/env bash
# Suggests:
# * spark: https://github.com/holman/spark

error() {
    >&2 echo "ERROR: $*"
    exit 1
}

chdir() {
    cd "$1" || error "Failed to change directory: $1"
}

BENCH_DATA_ROOT=${BENCH_DATA_ROOT:-~/wynton-bench-logs}
HOSTNAME=${HOSTNAME:-qb3-dev3}

[[ -d "$BENCH_DATA_ROOT" ]] || error "No such folder: ${BENCH_DATA_ROOT}"
[[ -n "$HOSTNAME" ]] || error "HOSTNAME is empty"

BENCH_DATA_PATH=${BENCH_DATA_ROOT}/${HOSTNAME}
[[ -d "$BENCH_DATA_PATH" ]] || exit 0

format=${FORMAT:-spark}
reverse=false
width=$(tput cols)

TEST_DRIVE=${TEST_DRIVE:-wynton_scratch}
LABEL=${LABEL:-/${TEST_DRIVE//_/\/}}
n=$((width-1))

## Load signals
signals=($(tail -n 2000 "$BENCH_DATA_PATH/bench-files-tarball__${TEST_DRIVE}.log" | grep -F "total_time" | sed -E 's/(.compbio.ucsf.edu|echo total_time=| seconds|-07:00)//g' | cut -d $'\t' -f 21))
signals=(${signals[@]:0:$n})
$reverse && signals=($(printf '%s\n' "${signals[@]}" | tac | tr '\n' ' '))

if [[ "$format" == "int" ]]; then
  printf "%0.f " "${signals[@]}"
elif [[ "$format" == "dbl" ]]; then
  echo "${signals[@]}"
elif [[ "$format" == "spark" ]]; then
  ~/bin/spark "200 ${signals[@]}"
fi

pad=$(((${#signals[@]}-8-2-${#LABEL})/2))
#echo "signals=${#signals[@]}"
#echo "pad=$pad"
if $reverse; then
    printf "^now%*s[%s]%*s%s\n" "$pad" "" "$LABEL" "$pad" "" "past^"
else    
    printf "^past%*s[%s]%*s%s\n" "$pad" "" "$LABEL" "$pad" "" "now^"
fi    

